name: ğŸ”„ Pull Request

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-checks:
    name: ğŸ” PR Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.8.0'
          channel: 'stable'

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ” Analyze code
        run: flutter analyze

      - name: ğŸ§ª Run tests
        run: flutter test --coverage

      - name: ğŸ“Š Coverage check
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "âœ… Coverage file generated successfully"
          else
            echo "âŒ Coverage file not found"
            exit 1
          fi

      - name: ğŸ—ï¸ Test build
        run: flutter build apk --debug

  notify-success:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: pr-checks
    if: success()
    steps:
      - name: ğŸ‰ Comment on PR - Success
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `## âœ… All checks passed! ğŸ‰
              
              Your pull request has successfully passed all automated tests and checks:
              
              - âœ… Code analysis
              - âœ… Unit tests
              - âœ… Coverage check
              - âœ… Build verification
              
              The PR is now ready for review by the maintainers. 
              
              **@owner** - This PR is pending your approval! ğŸ‘€`
            });

  notify-failure:
    name: ğŸ“¢ Notify Failure
    runs-on: ubuntu-latest
    needs: pr-checks
    if: failure()
    steps:
      - name: âŒ Comment on PR - Failure
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `## âŒ Checks failed! 
              
              Some automated checks have failed for this pull request:
              
              Please review the [workflow run](https://github.com/${owner}/${repo}/actions/runs/${context.runId}) for detailed error information.
              
              Common issues to check:
              - ğŸ” Code analysis warnings/errors
              - ğŸ§ª Failing unit tests
              - ğŸ“Š Insufficient test coverage
              - ğŸ—ï¸ Build failures
              
              Please fix the issues and push new commits to trigger the checks again.`
            });

  auto-merge:
    name: ğŸ”„ Auto Merge
    runs-on: ubuntu-latest
    needs: [pr-checks, notify-success]
    if: |
      success() && 
      contains(github.event.pull_request.labels.*.name, 'auto-merge') &&
      github.event.pull_request.user.login == github.repository_owner
    steps:
      - name: ğŸš€ Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            // Enable auto-merge with squash method
            await github.rest.pulls.enableAutoMerge({
              owner,
              repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });
            
            // Add comment about auto-merge
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `## ğŸ¤– Auto-merge enabled!
              
              This PR has been configured for automatic merging:
              - âœ… All checks passed
              - ğŸ·ï¸ Auto-merge label detected
              - ğŸ‘¤ PR created by repository owner
              
              The PR will be automatically merged once approved by a maintainer.`
            });
