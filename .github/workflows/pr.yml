name: 🔄 Pull Request

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-checks:
    name: 🔍 PR Checks
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 🐦 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.8.0'
          channel: 'stable'

      - name: 📦 Get dependencies
        run: flutter pub get

      - name: 🔍 Analyze code
        run: flutter analyze

      - name: 🧪 Run tests
        run: flutter test --coverage

      - name: 📊 Coverage check
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "✅ Coverage file generated successfully"
          else
            echo "❌ Coverage file not found"
            exit 1
          fi

      - name: 🏗️ Test build
        run: flutter build apk --debug

  notify-success:
    name: 📢 Notify Success
    runs-on: ubuntu-latest
    needs: pr-checks
    if: success()
    steps:
      - name: 🎉 Comment on PR - Success
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `## ✅ All checks passed! 🎉
              
              Your pull request has successfully passed all automated tests and checks:
              
              - ✅ Code analysis
              - ✅ Unit tests
              - ✅ Coverage check
              - ✅ Build verification
              
              The PR is now ready for review by the maintainers. 
              
              **@owner** - This PR is pending your approval! 👀`
            });

  notify-failure:
    name: 📢 Notify Failure
    runs-on: ubuntu-latest
    needs: pr-checks
    if: failure()
    steps:
      - name: ❌ Comment on PR - Failure
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `## ❌ Checks failed! 
              
              Some automated checks have failed for this pull request:
              
              Please review the [workflow run](https://github.com/${owner}/${repo}/actions/runs/${context.runId}) for detailed error information.
              
              Common issues to check:
              - 🔍 Code analysis warnings/errors
              - 🧪 Failing unit tests
              - 📊 Insufficient test coverage
              - 🏗️ Build failures
              
              Please fix the issues and push new commits to trigger the checks again.`
            });

  auto-merge:
    name: 🔄 Auto Merge
    runs-on: ubuntu-latest
    needs: [pr-checks, notify-success]
    if: |
      success() && 
      contains(github.event.pull_request.labels.*.name, 'auto-merge') &&
      github.event.pull_request.user.login == github.repository_owner
    steps:
      - name: 🚀 Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            // Enable auto-merge with squash method
            await github.rest.pulls.enableAutoMerge({
              owner,
              repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });
            
            // Add comment about auto-merge
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `## 🤖 Auto-merge enabled!
              
              This PR has been configured for automatic merging:
              - ✅ All checks passed
              - 🏷️ Auto-merge label detected
              - 👤 PR created by repository owner
              
              The PR will be automatically merged once approved by a maintainer.`
            });
