name: ğŸ”€ PR Approved

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [closed]

jobs:
  handle-approval:
    name: ğŸ¯ Handle PR Approval
    runs-on: ubuntu-latest
    if: github.event.review.state == 'approved' && github.event.pull_request.draft == false

    steps:
    - name: ğŸ‰ PR Approved Notification
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const review = context.payload.review;
          const reviewer = review.user.login;
          const author = pr.user.login;
          
          let message = `## ğŸ‰ PR Approved!\n\n`;
          message += `**@${reviewer}** has approved this PR! ğŸ‘\n\n`;
          
          if (review.body) {
            message += `ğŸ’¬ **Review comment:**\n> ${review.body}\n\n`;
          }
          
          message += `ğŸ”„ **Status:** Ready to merge\n`;
          message += `ğŸ¤– **Auto-merge:** Enabled (will merge automatically if all checks pass)\n\n`;
          message += `Thanks @${author} for the contribution! ğŸš€`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: message
          });

  handle-merge:
    name: ğŸŠ Handle Successful Merge
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
    - name: ğŸŠ Merge Success Notification
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const author = pr.user.login;
          const mergedBy = pr.merged_by ? pr.merged_by.login : 'unknown';
          
          console.log(`ğŸŠ PR #${pr.number} successfully merged!`);
          console.log(`ğŸ“ Title: ${pr.title}`);
          console.log(`ğŸ‘¤ Author: @${author}`);
          console.log(`ğŸ”€ Merged by: @${mergedBy}`);
          console.log(`ğŸŒ¿ From: ${pr.head.ref} â†’ ${pr.base.ref}`);
          
          // Create a celebration comment
          const message = `## ğŸŠ Successfully Merged!\n\n` +
            `This PR has been successfully merged into \`${pr.base.ref}\`! ğŸš€\n\n` +
            `ğŸ¯ **Merged:** ${pr.title}\n` +
            `ğŸ‘¤ **Author:** @${author}\n` +
            `ğŸ”€ **Merged by:** @${mergedBy}\n` +
            `ğŸŒ¿ **Branch:** \`${pr.head.ref}\` â†’ \`${pr.base.ref}\`\n\n` +
            `âœ¨ Great work team! The changes are now live on the main branch.\n\n` +
            `ğŸ”„ **Next steps:**\n` +
            `- Build workflows will run automatically\n` +
            `- Changes will be available in the next release\n` +
            `- Branch \`${pr.head.ref}\` can be safely deleted`;
          
          // We can't comment on closed PRs, so we'll just log the success
          console.log('ğŸ“ Merge notification prepared (PR is closed, comment not posted)');

  cleanup-branch:
    name: ğŸ§¹ Cleanup Feature Branch
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.event.pull_request.head.repo.full_name == github.repository

    steps:
    - name: ğŸ§¹ Delete merged branch
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const branchName = pr.head.ref;
          
          // Don't delete main, develop, or release branches
          const protectedBranches = ['main', 'master', 'develop', 'staging', 'production'];
          if (protectedBranches.includes(branchName)) {
            console.log(`ğŸ›¡ï¸ Skipping deletion of protected branch: ${branchName}`);
            return;
          }
          
          try {
            await github.rest.git.deleteRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branchName}`
            });
            
            console.log(`ğŸ—‘ï¸ Successfully deleted branch: ${branchName}`);
          } catch (error) {
            console.log(`âš ï¸ Could not delete branch ${branchName}: ${error.message}`);
          }
